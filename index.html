<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç§’é€Ÿç›¤é»æ©Ÿ v2.2</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); margin: 0; padding: 20px;
            color: #1c1c1e; text-align: center;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        .api-box {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .api-input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; margin-top: 5px; font-size: 14px;
        }

        .action-area { display: grid; gap: 15px; }
        .big-btn {
            background: white; border: none; border-radius: 20px; padding: 30px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;
            transition: transform 0.1s; display: flex; flex-direction: column; align-items: center;
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn i { font-size: 40px; margin-bottom: 10px; color: var(--primary); }
        .big-btn span { font-size: 18px; font-weight: bold; color: #333; }
        .big-btn small { font-size: 12px; color: #888; margin-top: 5px; }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); 
            border-top-color: #00ffcc; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #result-preview { margin-top: 20px; text-align: left; background: white; padding: 15px; border-radius: 12px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="margin-top:0;">âš¡ AI ç§’é€Ÿç›¤é» v2.2</h2>
        
        <div class="api-box">
            <label style="font-size:12px; font-weight:bold; color:#666;">Google Gemini API Key:</label>
            <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Key (AIzaé–‹é ­)" oninput="saveKey()">
            <div id="key-status" style="font-size:12px; color:red; margin-top:5px;">æœªè¼¸å…¥ API Key</div>
        </div>

        <div class="action-area">
            <button class="big-btn" onclick="triggerCamera()">
                <i class="ri-camera-lens-fill"></i>
                <span>ğŸ“¸ å³å½± -> å³å‡º Excel</span>
                <small>è‡ªå‹•åˆ†æåŠä¸‹è¼‰</small>
            </button>

            <button class="big-btn" onclick="document.getElementById('file-upload').click()">
                <i class="ri-image-add-fill" style="color:#34c759;"></i>
                <span>ğŸ–¼ï¸ ä¸Šå‚³ç›¸ç‰‡</span>
                <small>é¸æ“‡ç›¸ç°¿å…§çš„åœ–ç‰‡</small>
            </button>
        </div>

        <input type="file" id="file-camera" accept="image/*" capture="environment" style="display:none" onchange="handleProcess(this)">
        <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleProcess(this)">

        <div id="result-preview">
            <h3>âœ… å·²å®Œæˆï¼</h3>
            <p>Excel (CSV) æª”æ¡ˆå·²è‡ªå‹•ä¸‹è¼‰ã€‚</p>
            <div id="data-dump" style="font-family:monospace; font-size:12px; color:#555; white-space: pre-wrap;"></div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="status-text">æ­£åœ¨åˆ†æåœ–ç‰‡...</div>
        <div id="sub-status">è«‹ç¨å€™...</div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        window.saveKey = function() {
            const key = document.getElementById('api-key').value;
            localStorage.setItem('gemini_key', key);
            checkKey();
        }

        function checkKey() {
            const key = document.getElementById('api-key').value;
            const status = document.getElementById('key-status');
            if(key.length > 10) {
                status.innerText = "âœ… API Key å·²æº–å‚™å¥½";
                status.style.color = "green";
                return true;
            } else {
                status.innerText = "âŒ è«‹è¼¸å…¥ API Key æ‰èƒ½ä½¿ç”¨";
                status.style.color = "red";
                return false;
            }
        }

        const savedKey = localStorage.getItem('gemini_key');
        if(savedKey) {
            document.getElementById('api-key').value = savedKey;
            checkKey();
        }

        window.triggerCamera = function() {
            if(!checkKey()) { alert("è«‹å…ˆè¼¸å…¥ API Keyï¼"); return; }
            document.getElementById('file-camera').click();
        }

        window.handleProcess = async function(input) {
            const file = input.files[0];
            if (!file) return;

            const overlay = document.getElementById('loading-overlay');
            const status = document.getElementById('status-text');
            const sub = document.getElementById('sub-status');
            overlay.style.display = 'flex';
            
            try {
                const base64Data = await readFileAsBase64(file);
                const apiKey = document.getElementById('api-key').value;
                const genAI = new GoogleGenerativeAI(apiKey);
                
                // === ä¿®æ­£é‡é»ï¼šæ”¹å›æ¨™æº–åç¨± "gemini-1.5-flash" ===
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                status.innerText = "ğŸ¤– AI æ€è€ƒä¸­...";
                sub.innerText = "æ­£åœ¨è¾¨è­˜å“ç‰Œèˆ‡æ•¸é‡...";

                const prompt = `
                    ä½ æ˜¯ä¸€å€‹å€‰å­˜ç³»çµ±ã€‚è«‹åˆ†æåœ–ç‰‡ä¸­çš„å•†å“ã€‚
                    è«‹éå¸¸ç²¾æº–åœ°è¾¨è­˜ã€Œå“ç‰Œ (Brand)ã€ã€ã€Œç”¢å“å…¨å (Full Name)ã€ã€ã€Œå…·é«”å‹è™Ÿ/å£å‘³/å®¹é‡ (Model/Flavor)ã€ä»¥åŠã€Œæ•¸é‡ (Quantity)ã€ã€‚
                    
                    è¼¸å‡ºæ ¼å¼å¿…é ˆæ˜¯ç´” JSON Arrayï¼Œä¸è¦æœ‰ Markdownï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                    [
                      {"brand": "ç¶­ä»–", "name": "æª¸æª¬èŒ¶", "spec": "250ml", "qty": 3},
                      {"brand": "Coca-Cola", "name": "Zero", "spec": "330ml", "qty": 1}
                    ]
                `;

                const result = await model.generateContent([
                    prompt,
                    { inlineData: { data: base64Data, mimeType: "image/jpeg" } }
                ]);
                
                const responseText = result.response.text();
                // æ¸…ç†å¯èƒ½å‡ºç¾çš„ json æ¨™è¨˜
                const jsonText = responseText.replace(/```json/g, "").replace(/```/g, "").trim();
                const data = JSON.parse(jsonText);

                status.innerText = "ğŸ“„ æ­£åœ¨ç”Ÿæˆ Excel...";
                downloadCSV(data);

                overlay.style.display = 'none';
                document.getElementById('result-preview').style.display = 'block';
                document.getElementById('data-dump').innerText = JSON.stringify(data, null, 2);
                alert("æˆåŠŸï¼Excel æª”æ¡ˆå·²ä¸‹è¼‰ã€‚");

            } catch (error) {
                console.error(error);
                // éŒ¯èª¤è™•ç†æç¤º
                let msg = error.message;
                if (msg.includes("404")) msg = "æ‰¾ä¸åˆ°æ¨¡å‹ï¼Œè«‹ç¢ºä¿ SDK ç‰ˆæœ¬æ­£ç¢ºã€‚";
                if (msg.includes("400")) msg = "ä½ç½®éŒ¯èª¤æˆ– API Key å•é¡Œ (è«‹æª¢æŸ¥ VPN)ã€‚";
                
                alert("éŒ¯èª¤ï¼š" + msg + "\n\nâš ï¸ å¦‚æœä½ åœ¨é¦™æ¸¯ï¼Œè«‹å‹™å¿…é–‹å•Ÿ VPN (é€£å»æ—¥æœ¬/å°ç£/ç¾åœ‹)ã€‚");
                overlay.style.display = 'none';
            }
            
            input.value = '';
        };

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function downloadCSV(data) {
            let csv = "\uFEFFå“ç‰Œ,ç”¢å“åç¨±,è¦æ ¼/å‹è™Ÿ,æ•¸é‡\n";
            data.forEach(item => {
                csv += `"${item.brand}","${item.name}","${item.spec}",${item.qty}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            
            const timeStr = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            link.setAttribute("download", `ç›¤é»çµæœ_${timeStr}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>