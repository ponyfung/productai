<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½ç›¤é»æ©Ÿ</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --primary: #007aff;
            --bg: #f2f2f7;
            --card-bg: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); margin: 0; padding: 20px;
            color: #1c1c1e; padding-bottom: 100px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg); border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px;
        }
        
        h1 { margin: 0 0 10px 0; font-size: 24px; text-align: center; }
        p { color: #666; font-size: 14px; text-align: center; margin-top: 0; }

        /* API Key è¼¸å…¥æ¡† */
        .api-input-box {
            background: #eef2ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dbeafe;
        }
        .api-input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px;
        }

        /* åœ–ç‰‡é è¦½ */
        .preview-box {
            width: 100%; min-height: 200px; background: #f9f9f9; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border: 2px dashed #ddd; margin-bottom: 15px; position: relative;
        }
        #preview-img { width: 100%; display: none; }
        .placeholder-text { color: #aaa; pointer-events: none; }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;
        }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #34c759; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th { background: #f2f2f7; text-align: left; padding: 10px; border-radius: 8px 8px 0 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“¸ AI æ™ºèƒ½ç›¤é»æ©Ÿ</h1>
        <p>æ‹ç…§ -> AI è­˜åˆ¥ -> åŒ¯å‡º Excel</p>

        <div class="api-input-box">
            <label style="font-size:12px; font-weight:bold; color:#007aff;">ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥ API Key</label>
            <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Google Gemini API Key">
            <div style="text-align:right; margin-top:5px;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:12px; color:#007aff;">ğŸ‘‰ æŒ‰æ­¤å…è²»ç²å– Key</a>
            </div>
        </div>

        <div class="card">
            <div class="preview-box" onclick="document.getElementById('file-input').click()">
                <img id="preview-img">
                <div class="placeholder-text" id="placeholder">
                    <i class="ri-camera-fill" style="font-size:40px; display:block; margin:0 auto;"></i>
                    é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³
                </div>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(event)">

            <button class="btn btn-blue" id="analyze-btn" onclick="analyzeImage()" disabled>
                <i class="ri-sparkling-fill"></i> é–‹å§‹ AI åˆ†æ
            </button>
        </div>

        <div class="card" id="result-card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“¦ ç›¤é»çµæœ</h3>
                <span id="item-count" style="background:#eee; padding:2px 8px; border-radius:10px; font-size:12px;">0 é …</span>
            </div>
            
            <div class="table-container">
                <table id="result-table">
                    <thead>
                        <tr>
                            <th>ç”¢å“åç¨±</th>
                            <th>æ•¸é‡</th>
                            <th>ç‰¹å¾µ/å‹è™Ÿ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn btn-green" onclick="downloadCSV()" style="margin-top:20px;">
                <i class="ri-file-excel-2-fill"></i> åŒ¯å‡º Excel (CSV)
            </button>
        </div>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <p>AI æ­£åœ¨æ•¸ç·Šè²¨... è«‹ç¨å€™</p>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let currentBase64 = null;
        let aiData = [];

        // 1. è™•ç†åœ–ç‰‡é¡¯ç¤º
        window.handleFile = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBase64 = e.target.result.split(',')[1]; // æ‹¿æ‰ data:image... å‰ç¶´
                    const img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('analyze-btn').disabled = false; // å•Ÿç”¨æŒ‰éˆ•
                };
                reader.readAsDataURL(file);
            }
        }

        // 2. å‘¼å« AI åˆ†æ
        window.analyzeImage = async function() {
            const key = document.getElementById('api-key').value;
            if(!key) { alert("è«‹å…ˆè¼¸å…¥ API Keyï¼"); return; }

            document.getElementById('loader').style.display = 'flex';

            try {
                const genAI = new GoogleGenerativeAI(key);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                // é€™æ˜¯çµ¦ AI çš„æŒ‡ä»¤ (Prompt)
                const prompt = `
                    ä½ æ˜¯ä¸€å€‹å€‰å­˜ç®¡ç†å“¡ã€‚è«‹åˆ†æé€™å¼µåœ–ç‰‡ï¼Œæ‰¾å‡ºæ‰€æœ‰ç”¢å“ã€‚
                    è«‹åˆ†è¾¨ç”¢å“çš„ã€Œå“ç‰Œã€ã€ã€Œå‹è™Ÿ/å£å‘³/ç‰¹å¾µã€ä»¥åŠã€Œæ•¸é‡ã€ã€‚
                    å¦‚æœæœ‰å¤šå€‹ç›¸åŒçš„ç”¢å“ï¼Œè«‹åˆä½µè¨ˆç®—æ•¸é‡ã€‚
                    
                    è«‹ç›´æ¥å›å‚³ç´” JSON æ ¼å¼ (Array)ï¼Œä¸è¦ Markdownï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                    [
                        {"name": "ç”¢å“å…¨å", "brand": "å“ç‰Œ", "model": "å‹è™Ÿæˆ–ç‰¹å¾µ", "qty": æ•¸å­—}
                    ]
                `;

                const imagePart = {
                    inlineData: { data: currentBase64, mimeType: "image/jpeg" }
                };